<!DOCTYPE html>
<html>
<head>
    <title>Custom shader</title>
    <script src="../myr.js"></script>
</head>
<body>
    <canvas id="renderer" width=800 height=600></canvas>
    <script>
        const canvas = document.getElementById("renderer");
        const myr = new Myr(canvas);
        const surface = new myr.Surface(myr.getWidth(), myr.getHeight());
        const shader = new myr.Shader(
            "mediump vec2 movedUV = uv + vec2(sin(time * 5.0 + uv.y * 45.0) * 0.01, cos(-time * 4.0 + uv.x * 45.0) * 0.01);" +
            "mediump vec4 result = texture(source0, uv) + texture(source0, movedUV);" +
            "color=vec4(result.rgb, result.a);",
            3,
            ["time"]);
        let moved = false;
        let mouseXPrevious = 0;
        let mouseYPrevious = 0;
        let mouseX = 0;
        let mouseY = 0;
        let time = 0;

        shader.setSources([surface]);

        canvas.addEventListener("mousemove", function(event) {
            const rect = canvas.getBoundingClientRect();

            if (!moved) {
                mouseXPrevious = event.clientX - rect.left;
                mouseYPrevious = event.clientY - rect.top;
            }
            else {
                mouseXPrevious = mouseX;
                mouseYPrevious = mouseY;
            }

            mouseX = event.clientX - rect.left;
            mouseY = event.clientY - rect.top;

            moved = true;
        });

        canvas.addEventListener("click", function() {
            surface.bind();
            surface.clear();
        });

        myr.setClearColor(new Myr.Color(0.5, 0.6, 0.7));

        myr.utils.loop(function(timeStep) {
            surface.bind();

            if (moved)
                myr.primitives.drawLine(
                    Myr.Color.WHITE,
                    mouseXPrevious,
                    mouseYPrevious,
                    mouseX,
                    mouseY);

            myr.bind();
            myr.clear();

            time += timeStep;

            shader.setVariable("time", time);
            shader.draw(0, 0, surface.getWidth(), surface.getHeight());

            myr.flush();

            return true;
        });
    </script>
</body>
</html>
